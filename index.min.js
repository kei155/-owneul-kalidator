"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};require("formdata-polyfill"),require("weakmap-polyfill");var moment_1=__importDefault(require("moment")),TesterNotFoundError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),InvalidRuleError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),InvalidValueError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),is={empty:function(e){return null==e||e.length&&0===e.length||e instanceof FileList&&0===e.length},number:function(e){return!isNaN(e)},file:function(e,t,r){if(void 0===t&&(t=""),!(e instanceof File))return!1;if("*/*"!==t){var i=t.match(/(.*\/)\*/);if(i){if(0!==e.type.indexOf(i[1]))return!1}else if(""!==t&&e.type!==t)return!1}if(r=Array.isArray(r)?r:[r],!is.empty(r)){e=e.name.split(".");if(0<e.length){e=e[e.length-1];if(-1===r.indexOf(e))return!1}}return!0}},Kalidator=function(){function d(e,t,r){var l=this;this.data={},this.$rules={},this.$testers={},this.$messages={},this.$unlabeledRules={},this.$keyAndLabels={},this.$requiredKeys=[],this.$customTester={},this.$customMessages={},this.errors={},this.isPassed=!1,this.$is=is,this.firstErrorMessage="",this.$defaults={messages:{required:":param(은/는) 필수입력사항입니다.",requiredIf:"[:$0] 값이 있는 경우 :param(은/는) 필수입력사항입니다.",minLength:":param(은/는) 최소 :$0자를 입력해야합니다.",maxLength:":param(은/는) 최대 :$0자까지 입력할 수 있습니다.",betweenLength:":param(은/는) :$0자 ~ :$1자 사이에서 입력할 수 있습니다.",minValue:":param의 값은 최소 :$0입니다.",maxValue:":param의 값은 최대 :$0입니다.",betweenValue:":param의 값은 :$0 ~ :$1 사이만 가능합니다.",in:":param의 값은 :$concat 중 하나여야합니다.",notIn:":param의 값은 :$concat 이외의 값이어야합니다.",empty:":param의 값은 비어있어야 합니다.",notEmpty:":param의 값은 비어있지 않아야 합니다.",number:":param의 값은 숫자여야합니다.",email:":param의 값은 유효한 이메일 주소여야합니다.",date:":param의 값은 날짜여야합니다.",file:":param 파일이 정상적으로 첨부되지 않았습니다.",earlierThan:":param(은/는) :$0보다 이른 날짜여야합니다.",earlierOrEqualThan:":param(은/는) :$0과 같거나 :$0보다 이른 날짜여야합니다.",laterThan:":param(은/는) :$0보다 늦은 날짜여야합니다.",laterOrEqualThan:":param(은/는) :$0과 같거나 :$0보다 늦은 날짜여야합니다."},testers:{required:function(e,t,r){return void 0===t&&(t=[]),void 0===r&&(r={}),!l.$is.empty(d.getTargetValue(r,e))},requiredIf:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return!!l.$is.empty(t)||(0!==i.length&&-1===i.indexOf(t)||!l.$is.empty(d.getTargetValue(r,e)))},requiredNotIf:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return t&&(null===t||-1===i.indexOf(t))||!l.$is.empty(d.getTargetValue(r,e))},minLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("minLength",e))return!0;t=t[0];if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("길이값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return isNaN(e.length)?e.toString().length>=t:e.length>=t},maxLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("maxLength",e))return!0;t=t[0];if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("길이값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return isNaN(e.length)?e.toString().length<=t:e.length<=t},betweenLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("betweenLength",e))return!0;var i=t[0],t=t[1];if(isNaN(Number.parseInt(i)))throw new InvalidRuleError("최소 길이값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("최대 길이값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");return l.$defaults.testers.minLength(e,[i],r)&&l.$defaults.testers.maxLength(e,[t],r)},minValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("minValue",e))return!0;t=t[0];if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("최소 조건값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return is.number(e)&&t<=+e},maxValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("maxValue",e))return!0;var i=t[0];if(isNaN(Number.parseInt(i)))throw new InvalidRuleError("최대 조건값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return is.number(e)&&+e<=i},betweenValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("betweenValue",e))return!0;var i=t[0],t=t[1];if(isNaN(Number.parseInt(i)))throw new InvalidRuleError("최소 조건값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("최대 조건값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");return l.$defaults.testers.minValue(e,i,r)&&l.$defaults.testers.maxValue(e,t,r)},in:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("in",e))return!0;t=t.filter(function(e){return null!=e}),e=d.getTargetValue(r,e);return-1!==t.indexOf(e)},notIn:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("notIn",e))return!0;t=t.filter(function(e){return null!=e}),e=d.getTargetValue(r,e);return-1===t.indexOf(e)},empty:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("empty",e))return!0;e=d.getTargetValue(r,e);return null===e||(!!is.empty(e)||""===e.toString().replace(/<br\s?\/?>/g,"").replace(/<\/?p\s?>/g,"").trim())},notEmpty:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("notEmpty",e))return!0;e=d.getTargetValue(r,e);return null!==e&&!is.empty(e)&&""!==e.toString().replace(/<br\s?\/?>/g,"").replace(/<\/?p\s?>/g,"").trim()},number:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("number",e))return!0;e=d.getTargetValue(r,e);return is.number(e)},email:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("email",e))return!0;e=d.getTargetValue(r,e);if("string"!=typeof e)throw new InvalidValueError("전달된 값 ["+e+"]이 문자열이 아닙니다.");return null!==e.match(/@/g)&&1===(e.match(/@/g)||[]).length&&"@"!==e[0]&&"@"!==e[e.length-1]},date:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("date",e))return!0;var i=d.getTargetValue(r,e);try{return moment_1.default(i).isValid()}catch(e){return!1}},file:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("file",e))return!0;var i=t[0],n=t.slice(1),a=!0,s=d.getTargetValue(r,e);if(s instanceof FileList||Array.isArray(s))for(var o=0;o<s.length;o++)var u=s[o],a=a&&is.file(u,i,n);else a=s instanceof File&&is.file(s,i,n);return a},earlierThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("earlierThan",e))return!0;var i=d.getTargetValue(r,e),e=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t,r=moment_1.default(i),t=moment_1.default(e);if(!r.isValid())throw new InvalidValueError("검사대상값 ["+i+"]가 추출가능한 날짜값이 아닙니다.");if(!t.isValid())throw new InvalidValueError("비교대상값 ["+e+"]가 추출가능한 날짜값이 아닙니다.");return r.diff(t)<0},earlierOrEqualThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("earlierOrEqualThan",e))return!0;var i=d.getTargetValue(r,e),e=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t,r=moment_1.default(i),t=moment_1.default(e);if(!r.isValid())throw new InvalidValueError("검사대상값 ["+i+"]가 추출가능한 날짜값이 아닙니다.");if(!t.isValid())throw new InvalidValueError("비교대상값 ["+e+"]가 추출가능한 날짜값이 아닙니다.");return r.diff(t)<=0},laterThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("laterThan",e))return!0;var i=d.getTargetValue(r,e),e=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t,r=moment_1.default(i),t=moment_1.default(e);if(!r.isValid())throw new InvalidValueError("검사대상값 ["+i+"]가 추출가능한 날짜값이 아닙니다.");if(!t.isValid())throw new InvalidValueError("비교대상값 ["+e+"]가 추출가능한 날짜값이 아닙니다.");return 0<r.diff(t)},laterOrEqualThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("laterOrEqualThan",e))return!0;var i=d.getTargetValue(r,e),e=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t,r=moment_1.default(i),t=moment_1.default(e);if(!r.isValid())throw new InvalidValueError("검사대상값 ["+i+"]가 추출가능한 날짜값이 아닙니다.");if(!t.isValid())throw new InvalidValueError("비교대상값 ["+e+"]가 추출가능한 날짜값이 아닙니다.");return 0<=r.diff(t)}}},this.$conditionalRequiredRules=["requiredIf","requiredNotIf"],this.setData(e),this.setRules(t),this.setMessages(r)}return d.setGlobalMessage=function(e,t){return d.globalMessage[e]=t,d},d.registGlobalTester=function(e,t){return d.globalTester[e]=t,d},d.getTargetValue=function(e,t){for(var r=t.split("."),i=Object.assign({},e),n=0;n<r.length;n++)var a=r[n],i=null==i||null==i[a]||null==i[a]?null:i[a];return i},d.prototype.__isRequired=function(e){return-1!==this.$requiredKeys.indexOf(e)},d.prototype.__isTestNotRequired=function(e,t){return-1===this.$conditionalRequiredRules.indexOf(e)&&!this.__isRequired(t)&&is.empty(d.getTargetValue(this.data,t))},d.prototype.applyZosa=function(e){var i=e,t=["(은/는)","(이/가)","(을/를)","(과/와)","(아/야)","(이여/여)","(이랑/랑)","(으로/로)","(으로서/로서)","(으로써/로써)","(으로부터/로부터)"];t.forEach(function(e){var t=e.split("/")[0].replace("(",""),r=e.split("/")[1].replace(")","");i=i.replace(new RegExp("\\("+r+"/"+t+"\\)","g"),e)});for(var r=0;r<t.length;r++){var n,a=t[r];-1===e.indexOf(a)||(0<=(n=e.charCodeAt(e.indexOf(a)-1)-44032)||n<=11171)&&(i=i.replace(a,n%28!=0?a.split("/")[0].replace("(",""):a.split("/")[1].replace(")","")))}return i},d.prototype.test=function(e,t){var u=this,e=e,r="";-1!==e.indexOf("(")&&-1!==e.indexOf(")")&&(e=(i=e.split("("))[0],i.slice(1).join("(").replace(/\)$/,""));var i,n=[];-1!==t.indexOf(":")?(i=t.split(":"),r=i[0],n=-1!==i[1].indexOf(",")?i[1].split(","):[i[1]]):r=t;var a=this.$testers[r];if(!a)throw new TesterNotFoundError("Tester ["+r+"] Not Found.");for(var s=[e];!s.some(function(e){return-1===e.indexOf("*")});)!function(){var o=[];s.forEach(function(e){var t=e.split("."),r=t.indexOf("*");if(-1<r){var i=t.slice(0,r),n=d.getTargetValue(u.data,i.join("."));if(null!==n)for(var a=0;a<n.length;a++){var s=t.concat([]);s.splice(r,1,a.toString()),o.push(s.join("."))}else o.push(t.join("."))}else o.push(e)}),s=o}();return Promise.all(s.map(function(e){var t=a(e,n,u.data);return t instanceof Promise?t:new Promise(function(e){e(t)})}))},d.prototype.setData=function(e){var t,r=this;if(this.data={},e instanceof FormData)e.forEach(function(e,t){r.data[t]&&Array.isArray(r.data[t])?r.data[t].push(e):r.data[t]&&!Array.isArray(r.data[t])?r.data[t]=[r.data[t],e]:r.data[t]=e});else if(e instanceof HTMLElement)for(var i=e.querySelectorAll("[name]"),n=0;n<i.length;n++){var a=i[n],s=a.getAttribute("type"),o=a.getAttribute("name")||"noname";if(a instanceof HTMLInputElement)"radio"==s||"checkbox"==s?a.checked&&(this.data[o]=a.value):"file"==s?a.files&&1===a.files.length?this.data[o]=a.files[0]:a.files&&1<a.files.length?this.data[o]=a.files:this.data[o]=null:this.data[o]=a.value;else if(a instanceof HTMLSelectElement){var u=a.selectedOptions;if(1<u.length){this.data[o]=[];for(var l=0;l<u.length;l++)this.data[o].push(u[l].value)}else 1==u.length&&(this.data[o]=u[0].value)}}else if("object"==typeof e)for(var f in e)e.hasOwnProperty(f)&&(t=e[f],this.data[f]=t);return this},d.prototype.setRules=function(e){if(this.$rules={},null!=e)for(var t in e){var r;e.hasOwnProperty(t)&&(r=e[t],this.setRule(t,r))}return this},d.prototype.setRule=function(e,t){var r=e,i="";return this.$rules[e]=t,-1!==e.indexOf("(")&&-1!==e.indexOf(")")&&(r=(e=e.split("("))[0],i=e.slice(1).join("(").replace(/\)$/,"")),this.$unlabeledRules[r]=t,this.$keyAndLabels[r]=i,-1!==t.indexOf("required")&&this.$requiredKeys.push(r),this},d.prototype.setMessages=function(e){if(this.$customMessages={},e)for(var t in e){var r;e.hasOwnProperty(t)&&(r=e[t],this.setMessage(t,r))}return this},d.prototype.setMessage=function(e,t){return this.$customMessages[e]=t,this},d.prototype.registTester=function(e,t){return this.$customTester[e]=t,this},d.prototype.run=function(e){var f=this;return this.$testers=Object.assign(this.$defaults.testers,d.globalTester,this.$customTester),this.$messages=Object.assign(this.$defaults.messages,d.globalMessage,this.$customMessages),this.firstErrorMessage="",Promise.all(Object.keys(this.$rules).map(function(l){if(f.$rules.hasOwnProperty(l))return f.$rules[l].map(function(e){var t=l,s="",o="";-1!==t.indexOf("(")&&-1!==t.indexOf(")")&&(t=(r=t.split("("))[0],s=r.slice(1).join("(").replace(/\)$/,""));var r,u=[];-1!==e.indexOf(":")?(r=e.split(":"),o=r[0],u=-1!==r[1].indexOf(",")?r[1].split(","):[r[1]]):o=e;var i=f.$testers[o];if(!i)throw new TesterNotFoundError("Tester ["+o+"] Not Found.");for(var n=[t];!n.some(function(e){return-1===e.indexOf("*")});)!function(){var o=[];n.forEach(function(e){var t=e.split("."),r=t.indexOf("*");if(-1<r){var i=t.slice(0,r),n=d.getTargetValue(f.data,i.join("."));if(null!==n)for(var a=0;a<n.length;a++){var s=t.concat([]);s.splice(r,1,a.toString()),o.push(s.join("."))}else o.push(t.join("."))}else o.push(e)}),n=o}();var t=n.map(function(t){var e=i(t,u,f.data),r=function(e){var t=e,r=t.split(".").some(function(e){return f.$is.number(e)});r&&(t=t.split(".").map(function(e){return f.$is.number(e)?"*":e}).join("."));var i,n=(f.$messages[e+"."+o]||f.$messages[t+"."+o]||f.$defaults.messages[o]||f.$defaults.messages[t]||"").replace(/:param/g,s||e).replace(/:value/g,d.getTargetValue(f.data,e));r&&(i=0,e.split(".").forEach(function(e){f.$is.number(e)&&(n=n.replace(new RegExp(":\\*"+i,"g"),""+(Number.parseInt(e)+1)),i++)}));var a=[];return u.forEach(function(e){a.push(f.$keyAndLabels[e]||e)}),n=n.replace(/:\$concat/g,"["+a.join(", ")+"]"),u.forEach(function(e,t){e=f.$keyAndLabels[e]||e;n=n.replace(new RegExp(":\\$"+t,"g"),e)}),f.applyZosa(n)}(t);return e instanceof Promise?e.then(function(e){return Promise.resolve({isPass:e,testerName:o,paramForRow:t,failMessage:r})}):Promise.resolve({isPass:e,testerName:o,paramForRow:t,failMessage:r})}),a=[];return t.forEach(function(e){a.push(e)}),Promise.all(a)})})).then(function(e){var t=[];return e.forEach(function(e){e.forEach(function(e){t.push(e)})}),f.isPassed=!0,Promise.all(t).then(function(e){return e.forEach(function(e){e.forEach(function(e){!0!==e.isPass&&(f.isPassed=!1,f.errors[e.paramForRow]=f.errors[e.paramForRow]||{},f.errors[e.paramForRow][e.testerName]=e.failMessage)})}),new Promise(function(e,t){f.isPassed?e():(e=f.errors[Object.keys(f.errors)[0]],f.firstErrorMessage=e[Object.keys(e)[0]],t({errors:f.errors,firstErrorMessage:f.firstErrorMessage}))})})})},d.globalMessage={},d.globalTester={},d}();module.exports=Kalidator;
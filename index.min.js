"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var r,i;if(null===this)throw new TypeError(" this is null or not defined");var a=Object(this),n=a.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(1<arguments.length&&(r=t),i=0;i<n;){var s;i in a&&(s=a[i],e.call(r,s,i,a)),i++}}),require("formdata-polyfill"),require("weakmap-polyfill");var moment_1=__importDefault(require("moment")),TesterNotFoundError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),InvalidRuleError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),InvalidValueError=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(Error),is={empty:function(e){return null==e||!isNaN(e.length)&&0===e.length||e instanceof FileList&&0===e.length||e instanceof File&&0===e.size},number:function(e){return!isNaN(e)},file:function(e,t,r){if(void 0===t&&(t=""),!(e instanceof File))return!1;if("*/*"!==t){var i=t.match(/(.*\/)\*/);if(i){if(0!==e.type.indexOf(i[1]))return!1}else if(""!==t&&e.type!==t)return!1}if(r=Array.isArray(r)?r:[r],!is.empty(r)){e=e.name.split(".");if(0<e.length){e=e[e.length-1];if(-1===r.indexOf(e))return!1}}return!0}},Kalidator=function(){function d(e,t,r){var l=this;this.data={},this.$rules={},this.$testers={},this.$messages={},this.$unlabeledRules={},this.$keyAndLabels={},this.$requiredKeys=[],this.$excludeKeys=[],this.$customTester={},this.$customMessages={},this.errors={},this.isPassed=!1,this.$is=is,this.firstErrorMessage="",this.$defaults={messages:{required:":param(은/는) 필수입력사항입니다.",requiredIf:"[:$0] 값이 있는 경우 :param(은/는) 필수입력사항입니다.",requiredAtLeast:":param, :$concat 중 최소 하나의 값은 존재해야합니다.",minLength:":param(은/는) 최소 :$0자를 입력해야합니다.",maxLength:":param(은/는) 최대 :$0자까지 입력할 수 있습니다.",betweenLength:":param(은/는) :$0자 ~ :$1자 사이에서 입력할 수 있습니다.",minValue:":param의 값은 최소 :$0입니다.",maxValue:":param의 값은 최대 :$0입니다.",betweenValue:":param의 값은 :$0 ~ :$1 사이만 가능합니다.",in:":param의 값은 :$concat 중 하나여야합니다.",notIn:":param의 값은 :$concat 이외의 값이어야합니다.",empty:":param의 값은 비어있어야 합니다.",notEmpty:":param의 값은 비어있지 않아야 합니다.",number:":param의 값은 숫자여야합니다.",email:":param의 값은 유효한 이메일 주소여야합니다.",date:":param의 값은 날짜여야합니다.",dateFormat:":param(을/를) :$0 형식으로 설정해주세요.",file:":param 파일이 정상적으로 첨부되지 않았습니다.",earlierThan:":param(은/는) :$0보다 이른 날짜여야합니다.",earlierOrEqualThan:":param(은/는) :$0과 같거나 :$0보다 이른 날짜여야합니다.",laterThan:":param(은/는) :$0보다 늦은 날짜여야합니다.",laterOrEqualThan:":param(은/는) :$0과 같거나 :$0보다 늦은 날짜여야합니다."},testers:{required:function(e,t,r){return void 0===t&&(t=[]),void 0===r&&(r={}),!l.$is.empty(d.getTargetValue(r,e))},requiredIf:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return!1===t||(!!l.$is.empty(t)||(0!==i.length&&-1===i.indexOf(t)||!l.$is.empty(d.getTargetValue(r,e))))},requiredNotIf:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return t&&(null===t||-1===i.indexOf(t))||!l.$is.empty(d.getTargetValue(r,e))},requiredAtLeast:function(e,t,r){return void 0===t&&(t=[]),void 0===r&&(r={}),0<[d.getTargetValue(r,e)].concat(t.map(function(e){return d.getTargetValue(r,e)})).filter(function(e){return!l.$is.empty(e)}).length},excludeIf:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return!1===t||l.$is.empty(t)||0!==i.length&&-1===i.indexOf(t)||l.$excludeKeys.push(e),!0},excludeUnless:function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={});var i=t.slice(1),t=d.getTargetValue(r,t[0]);return t&&(null===t||-1===i.indexOf(t))||l.$excludeKeys.push(e),!0},minLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("minLength",e))return!0;var i=t[0];if(isNaN(Number.parseFloat(i))&&(i=d.getTargetValue(r,t[0])),isNaN(Number.parseInt(i)))throw new InvalidRuleError("길이값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return null!==e&&(isNaN(e.length)?e.toString().length>=i:e.length>=i)},maxLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("maxLength",e))return!0;var i=t[0];if(isNaN(Number.parseFloat(i))&&(i=d.getTargetValue(r,t[0])),isNaN(Number.parseInt(i)))throw new InvalidRuleError("길이값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return null!==e&&(isNaN(e.length)?e.toString().length<=i:e.length<=i)},betweenLength:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("betweenLength",e))return!0;var i=t[0],t=t[1];if(isNaN(Number.parseInt(i)))throw new InvalidRuleError("최소 길이값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");if(isNaN(Number.parseInt(t)))throw new InvalidRuleError("최대 길이값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");return l.$defaults.testers.minLength(e,[i],r)&&l.$defaults.testers.maxLength(e,[t],r)},minValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("minValue",e))return!0;var i=t[0];if(isNaN(Number.parseFloat(i))&&(i=d.getTargetValue(r,t[0])),isNaN(Number.parseFloat(i)))throw new InvalidRuleError("최소 조건값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return is.number(e)&&Number.parseFloat(e)>=Number.parseFloat(i)},maxValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("maxValue",e))return!0;var i=t[0];if(isNaN(Number.parseFloat(i))&&(i=d.getTargetValue(r,t[0])),isNaN(Number.parseFloat(i)))throw new InvalidRuleError("최대 조건값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");e=d.getTargetValue(r,e);return is.number(e)&&Number.parseFloat(e)<=Number.parseFloat(i)},betweenValue:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("betweenValue",e))return!0;var i=t[0],t=t[1];if(isNaN(Number.parseFloat(i)))throw new InvalidRuleError("최소 조건값 ["+i+"]는 숫자로 변환할 수 없는 값입니다.");if(isNaN(Number.parseFloat(t)))throw new InvalidRuleError("최대 조건값 ["+t+"]는 숫자로 변환할 수 없는 값입니다.");return l.$defaults.testers.minValue(e,[i],r)&&l.$defaults.testers.maxValue(e,[t],r)},in:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("in",e))return!0;t=t.filter(function(e){return null!=e}),e=d.getTargetValue(r,e);return-1!==t.indexOf((e||"").toString())},notIn:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("notIn",e))return!0;t=t.filter(function(e){return null!=e}),e=d.getTargetValue(r,e);return-1===t.indexOf((e||"").toString())},empty:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("empty",e))return!0;e=d.getTargetValue(r,e);return null===e||(!!is.empty(e)||""===e.toString().replace(/<br\s?\/?>/g,"").replace(/<\/?p\s?>/g,"").trim())},notEmpty:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("notEmpty",e))return!0;e=d.getTargetValue(r,e);return null!==e&&!is.empty(e)&&""!==e.toString().replace(/<br\s?\/?>/g,"").replace(/<\/?p\s?>/g,"").trim()},number:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("number",e))return!0;e=d.getTargetValue(r,e);return is.number(e)},email:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("email",e))return!0;e=d.getTargetValue(r,e);return"string"==typeof e&&(null!==e.match(/@/g)&&1===(e.match(/@/g)||[]).length&&"@"!==e[0]&&"@"!==e[e.length-1])},date:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("date",e))return!0;var i=d.getTargetValue(r,e);try{return moment_1.default(i).isValid()}catch(e){return!1}},dateFormat:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("dateFormat",e))return!0;var i=d.getTargetValue(r,e),a=t[0];try{return i==moment_1.default(i).format(a)}catch(e){return!1}},file:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("file",e))return!0;var i=t[0],a=t.slice(1),n=!0,s=d.getTargetValue(r,e);if(s instanceof FileList||Array.isArray(s))for(var u=0;u<s.length;u++)var o=s[u],n=n&&is.file(o,i,a);else n=s instanceof File&&is.file(s,i,a);return n},earlierThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("earlierThan",e))return!0;e=d.getTargetValue(r,e),t=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t[0],e=moment_1.default(e),t=moment_1.default(t);return e.isValid()&&t.isValid()&&e.diff(t)<0},earlierOrEqualThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("earlierOrEqualThan",e))return!0;e=d.getTargetValue(r,e),t=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t[0],e=moment_1.default(e),t=moment_1.default(t);return e.isValid()&&t.isValid()&&e.diff(t)<=0},laterThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("laterThan",e))return!0;e=d.getTargetValue(r,e),t=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t[0],e=moment_1.default(e),t=moment_1.default(t);return e.isValid()&&t.isValid()&&0<e.diff(t)},laterOrEqualThan:function(e,t,r){if(void 0===t&&(t=[]),void 0===r&&(r={}),l.__isTestNotRequired("laterOrEqualThan",e))return!0;e=d.getTargetValue(r,e),t=null!==d.getTargetValue(r,t[0])?d.getTargetValue(r,t[0]):t[0],e=moment_1.default(e),t=moment_1.default(t);return e.isValid()&&t.isValid()&&0<=e.diff(t)}}},this.$conditionalRequiredRules=["requiredIf","requiredNotIf","requiredAtLeast"],this.setData(e),this.setRules(t),this.setMessages(r)}return d.setGlobalMessage=function(e,t){return d.globalMessage[e]=t,d},d.registGlobalTester=function(e,t){return d.globalTester[e]=t,d},d.getTargetValue=function(e,t){for(var r=t.split("."),i=Object.assign({},e),a=0;a<r.length;a++)var n=r[a],i=null==i||null==i[n]||null==i[n]?null:i[n];return i},d.prototype.__isRequired=function(e){return-1!==this.$requiredKeys.indexOf(e)},d.prototype.__isTestNotRequired=function(e,t){return-1===this.$conditionalRequiredRules.indexOf(e)&&!this.__isRequired(t)&&is.empty(d.getTargetValue(this.data,t))},d.prototype.applyZosa=function(e){var i=e,t=["(은/는)","(이/가)","(을/를)","(과/와)","(아/야)","(이여/여)","(이랑/랑)","(으로/로)","(으로서/로서)","(으로써/로써)","(으로부터/로부터)"];t.forEach(function(e){var t=e.split("/")[0].replace("(",""),r=e.split("/")[1].replace(")","");i=i.replace(new RegExp("\\("+r+"/"+t+"\\)","g"),e)});for(var r=0;r<t.length;r++){var a,n=t[r];-1===e.indexOf(n)||(0<=(a=e.charCodeAt(e.indexOf(n)-1)-44032)||a<=11171)&&(i=i.replace(n,a%28!=0?n.split("/")[0].replace("(",""):n.split("/")[1].replace(")","")))}return i},d.prototype.setData=function(e){var t,r=this;if(this.data={},e instanceof FormData)e.forEach(function(e,t){r.setValueByHtmlKey(t,e)});else if(e instanceof HTMLElement)for(var i=e.querySelectorAll("[name]"),a=0;a<i.length;a++){var n=i[a],s=n.getAttribute("type"),u=n.getAttribute("name")||"noname";if(n instanceof HTMLInputElement)"radio"==s||"checkbox"==s?n.checked&&this.setValueByHtmlKey(u,n.value):"file"==s?n.files&&1===n.files.length?this.setValueByHtmlKey(u,n.files[0]):n.files&&1<n.files.length?this.setValueByHtmlKey(u,n.files):this.setValueByHtmlKey(u,null):this.setValueByHtmlKey(u,n.value);else if(n instanceof HTMLSelectElement){var o=n.querySelectorAll("option:checked");if(1<o.length){this.data[u]=[];for(var l=0;l<o.length;l++)this.data[u].push(o[l].value)}else 1==o.length&&this.setValueByHtmlKey(u,o[0].value)}else n instanceof HTMLTextAreaElement&&this.setValueByHtmlKey(u,n.value)}else if("object"==typeof e)for(var f in e)e.hasOwnProperty(f)&&(t=e[f],this.setValueByHtmlKey(f,t));return this},d.prototype.setValueByHtmlKey=function(e,t){for(var r=e.replace(/\[([^\]]{1,})\]/g,".$1").split("."),i=this.data,a=0;a<r.length;a++){var n=r.length===a+1,s=r[a],u=/\[\]$/.test(s),o=(Array.isArray(i),s.replace(/\[\]$/,"")),s=!isNaN(Number.parseInt(r[a+1]));i[o]?Array.isArray(i[o])&&n&&i[o].push(t):i[o]=n?u?[t]:t:u||s?[]:{},i=i[o]}},d.prototype.setRules=function(e){if(this.$rules={},null!=e)for(var t in e){var r;e.hasOwnProperty(t)&&(r=e[t],this.setRule(t,r))}return this},d.prototype.setRule=function(e,t){var r=e,i="";return this.$rules[e]=t,-1!==e.indexOf("(")&&-1!==e.indexOf(")")&&(r=(e=e.split("("))[0],i=e.slice(1).join("(").replace(/\)$/,"")),this.$unlabeledRules[r]=t,this.$keyAndLabels[r]=i,-1!==t.indexOf("required")&&this.$requiredKeys.push(r),this},d.prototype.setMessages=function(e){if(this.$customMessages={},e)for(var t in e){var r;e.hasOwnProperty(t)&&(r=e[t],this.setMessage(t,r))}return this},d.prototype.setMessage=function(e,t){return this.$customMessages[e]=t,this},d.prototype.registTester=function(e,t){return this.$customTester[e]=t,this},d.prototype.run=function(p){var g=this;return this.$testers=Object.assign(this.$defaults.testers,d.globalTester,this.$customTester),this.$messages=Object.assign(this.$defaults.messages,d.globalMessage,this.$customMessages),this.firstErrorMessage="",Promise.all(Object.keys(this.$rules).map(function(s){if(g.$rules.hasOwnProperty(s))return g.$rules[s].map(function(e){var t=s,u="",o="";-1!==t.indexOf("(")&&-1!==t.indexOf(")")&&(t=(r=t.split("("))[0],u=r.slice(1).join("(").replace(/\)$/,""));var r,l=[];-1!==e.indexOf(":")?(r=e.split(":"),o=r[0],l=-1!==r[1].indexOf(",")?r[1].split(","):[r[1]]):o=e;var i=g.$testers[o];if(!i)throw new TesterNotFoundError("Tester ["+o+"] Not Found.");for(var a=[t],f=[],c=a.concat([]);0<a.length&&!a.some(function(e){return-1===e.indexOf("*")});)!function(){var u=[];a.filter(function(t){return!f.some(function(e){return e===t})}).forEach(function(t){var e=t.split("."),r=e.indexOf("*");if(-1<r){var i=e.slice(0,r),a=d.getTargetValue(g.data,i.join("."));if(null!==a){c=c.filter(function(e){return e!==t});for(var n=0;n<a.length;n++){var s=e.concat([]);s.splice(r,1,n.toString()),u.push(s.join(".")),c.push(s.join("."))}}else f.push(t),u.push(e.join(".")),c.push(t)}else u.push(t),c.push(t)}),a=u}();var t=c.map(function(s){var e=l.concat([]);l.some(function(e){return-1<e.indexOf("*")})&&(e=l.map(function(e){for(var t=s.split("."),r=e.split("."),i=[],a=0;a<r.length;a++){var n=r[a];"*"!==n||isNaN(t[a])?i.push(n):i.push(t[a])}return i.join(".")}));var t=function(e){var t=e,r=t.split(".").some(function(e){return g.$is.number(e)});r&&(t=t.split(".").map(function(e){return g.$is.number(e)?"*":e}).join("."));var i,a=(g.$messages[e+"."+o]||g.$messages[t+"."+o]||g.$defaults.messages[o]||g.$defaults.messages[t]||"").replace(/:param/g,u||e).replace(/:value/g,d.getTargetValue(g.data,e));r&&(i=0,e.split(".").forEach(function(e){g.$is.number(e)&&(a=a.replace(new RegExp(":\\*"+i,"g"),""+(Number.parseInt(e)+1)),i++)}));var n=[];return l.forEach(function(e){var t,r=g.$keyAndLabels[e];r||(t=e.split(".").map(function(e){return isNaN(Number.parseFloat(e))?e:"*"}).join("."),r=g.$keyAndLabels[t]),r=r||e,n.push(r)}),a=a.replace(/:\$concat/g,"["+n.join(", ")+"]"),l.forEach(function(e,t){var r,i=g.$keyAndLabels[e];i||(r=e.split(".").map(function(e){return isNaN(Number.parseFloat(e))?e:"*"}).join("."),i=g.$keyAndLabels[r]),i=i||e,a=a.replace(new RegExp(":\\$"+t,"g"),i)}),g.applyZosa(a)}(s),r=!1;if(-1<g.$excludeKeys.indexOf(s))r=Promise.resolve(!0);else try{r=i(s,e,g.data)}catch(e){r=!1,t=e.message}return r instanceof Promise?r.then(function(e){return Promise.resolve({isPass:e,testerName:o,paramForRow:s,failMessage:t})}).catch(Promise.reject):Promise.resolve({isPass:r,testerName:o,paramForRow:s,failMessage:t})}),n=[];return t.forEach(function(e){n.push(e)}),Promise.all(n)})})).then(function(e){var t=[];return e.forEach(function(e){e.forEach(function(e){t.push(e)})}),g.isPassed=!0,Promise.all(t).then(function(e){return e.forEach(function(e){e.forEach(function(e){!0!==e.isPass&&(g.isPassed=!1,g.errors[e.paramForRow]=g.errors[e.paramForRow]||{},g.errors[e.paramForRow][e.testerName]=e.failMessage)})}),new Promise(function(e,t){if(g.isPassed)p&&p.pass&&"function"==typeof p.pass&&p.pass(),e(g.data);else{for(var r=Object.keys(g.errors),i=r[0],a=i,n=0;a.match(/\.[1-9]*\./)&&n<1e3;){for(var s=a.match(/\.([1-9]*)\./),u=Number.parseInt(s[1]),o=a.slice(0,s.index||0),l=0;l<u;l++)for(var f=0;f<r.length;f++){var c=r[f];if(c.startsWith(o+"."+l)){i=c;break}}a=a.replace(/\.([1-9]*)\./,"."+(u-1)+"."),n++}var d=g.errors[i],e=Object.keys(d)[0];g.firstErrorMessage=d[e],p&&p.fail&&"function"==typeof p.fail&&p.fail(g.errors,g.firstErrorMessage),t({errors:g.errors,firstErrorMessage:g.firstErrorMessage})}})})})},d.globalMessage={},d.globalTester={},d}();module.exports=Kalidator;